@model GymBLL.ModelVM.Member.MemberDashboardVM

@{
    ViewData["Title"] = "My Dashboard";
}

<!-- Review Modal Container -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="reviewModalContent" style="background: var(--tile); color: var(--ink); border: 1px solid var(--frame) !important;">
            <!-- Modal content will be loaded here via AJAX -->
        </div>
    </div>
</div>

<div class="dashboard-content py-4">
    <!-- Welcome Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="display-5 fw-bold mb-2">Hello, <span class="text-primary">@Model.MemberName</span> <span class="fs-4">ðŸ‘‹</span></h1>
             <p class="text-muted h5">"The only bad workout is the one that didn't happen."</p>
        </div>
        <div class="text-end d-none d-md-block">
            <h4 class="text-primary fw-bold mb-0">@DateTime.Now.ToString("dddd")</h4>
            <p class="mb-0 opacity-75">@DateTime.Now.ToString("dd MMMM yyyy")</p>
        </div>
    </div>

    <!-- AI Generator Banner Removed -->

    <!-- Top Key Metrics (3-Column Layout) -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card border-0 shadow-lg h-100 focus-card">
                 <div class="card-body p-4 position-relative z-1 d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-uppercase mb-2 ls-1" style="color: var(--muted);">Current Weight</h6>
                         @if (Model.WeightHistory != null && Model.WeightHistory.Any())
                        {
                             <h2 class="display-5 fw-bold mb-0" style="color: var(--ink);">@Model.WeightHistory.OrderByDescending(w => w.DateRecorded).First().Weight <span class="fs-4" style="color: var(--muted);">kg</span></h2>
                             <span class="badge bg-success bg-opacity-10 text-success mt-2">
                                <i class="fas fa-history me-1"></i> Latest
                             </span>
                        }
                        else
                        {
                             <h2 class="display-6 fw-bold mb-0" style="color: var(--muted);">--</h2>
                             <span class="small" style="color: var(--muted);">No logs yet</span>
                        }
                    </div>
                     <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                        <i class="fas fa-weight fa-2x"></i>
                    </div>
                 </div>
                  <div class="focus-card-bg" style="background-image: url('https://images.unsplash.com/photo-1576678927484-cc907957088c?auto=format&fit=crop&q=80&w=250');"></div>
            </div>
        </div>

        <div class="col-md-4">
             <div class="card border-0 shadow-lg h-100 focus-card">
                 <div class="card-body p-4 position-relative z-1 d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-uppercase mb-2 ls-1" style="color: var(--muted);">Total Workouts</h6>
                        <h2 class="display-5 fw-bold mb-0" style="color: var(--ink);">@Model.TotalWorkouts</h2>
                        <span class="badge bg-info bg-opacity-10 text-info mt-2">
                            <i class="fas fa-fire me-1"></i> Lifetime
                        </span>
                    </div>
                     <div class="icon-shape bg-info bg-opacity-10 text-info rounded-circle p-3">
                        <i class="fas fa-dumbbell fa-2x"></i>
                    </div>
                 </div>
                 <div class="focus-card-bg" style="background-image: url('https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?auto=format&fit=crop&q=80&w=250');"></div>
            </div>
        </div>

         <div class="col-md-4">
             <div class="card border-0 shadow-lg h-100 focus-card">
                 <div class="card-body p-4 position-relative z-1 d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-uppercase mb-2 ls-1" style="color: var(--muted);">Active Plan</h6>
                        @if (Model.SubscriptionStatus != null)
                        {
                            <h3 class="fw-bold mb-0 text-truncate" style="max-width: 150px; color: var(--ink);">@Model.SubscriptionStatus.MembershipType</h3>
                            <div class="d-flex align-items-center mt-2">
                                 <div class="progress flex-grow-1 me-2" style="height: 6px; background: var(--frame);">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: @(Model.SubscriptionStatus.DaysRemaining > 0 ? "75" : "0")%"></div>
                                </div>
                                <span class="small text-warning fw-bold">@Model.SubscriptionStatus.DaysRemaining days</span>
                            </div>
                            
                            @if (Model.SubscriptionStatus.IsExpired || Model.SubscriptionStatus.DaysRemaining <= 5)
                            {
                                <div class="mt-3">
                                    <a asp-controller="Member" asp-action="RenewSubscription" asp-route-id="@Model.SubscriptionStatus.SubscriptionId" class="btn btn-warning btn-sm w-100 fw-bold">
                                        <i class="fas fa-sync-alt me-1"></i> Renew Now
                                    </a>
                                </div>
                            }
                            else if (Model.SubscriptionStatus.DaysRemaining > 0)
                            {
                                <div class="mt-3">
                                    <a asp-controller="Member" asp-action="UpgradeSubscription" class="btn btn-outline-primary btn-sm w-100">
                                        <i class="fas fa-arrow-up me-1"></i> Upgrade
                                    </a>
                                </div>
                            }
                        }
                        else
                        {
                             <h4 class="mb-0" style="color: var(--muted);">None</h4>
                             <a asp-controller="Home" asp-action="Index" class="small text-primary text-decoration-none">View Plans</a>
                        }
                    </div>
                     <div class="icon-shape bg-warning bg-opacity-10 text-warning rounded-circle p-3">
                        <i class="fas fa-crown fa-2x"></i>
                    </div>
                 </div>
                   <div class="focus-card-bg" style="background-image: url('https://images.unsplash.com/photo-1554284126-bb6322d419c8?auto=format&fit=crop&q=80&w=250');"></div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Content Column -->
        <div class="col-lg-8">
             <!-- Quick Action Grid -->
             <h5 class="mb-3 ls-1">Quick Actions</h5>
             <div class="row g-3 mb-5">
                 <div class="col-6 col-md-3">
                     <button type="button" class="btn btn-outline-secondary h-100 w-100 p-3 d-flex flex-column align-items-center justify-content-center gap-2 hover-elevate shadow-sm" style="background: var(--tile); border: 1px solid var(--frame) !important;" data-bs-toggle="modal" data-bs-target="#weightModal">
                         <i class="fas fa-weight-scale fa-2x text-primary mb-1"></i>
                         <span class="small fw-bold" style="color: var(--ink);">Log Weight</span>
                     </button>
                 </div>
                  <div class="col-6 col-md-3">
                    <a asp-controller="WorkoutLog" asp-action="History" class="btn btn-outline-secondary h-100 w-100 p-3 d-flex flex-column align-items-center justify-content-center gap-2 hover-elevate shadow-sm" style="background: var(--tile); border: 1px solid var(--frame) !important;">
                         <i class="fas fa-dumbbell fa-2x text-success mb-1"></i>
                         <span class="small fw-bold" style="color: var(--ink);">Workout History</span>
                     </a>
                 </div>
                  <div class="col-6 col-md-3">
                    <a asp-controller="MealLog" asp-action="Index" asp-route-assignmentId="Index" class="btn btn-outline-secondary h-100 w-100 p-3 d-flex flex-column align-items-center justify-content-center gap-2 hover-elevate shadow-sm" style="background: var(--tile); border: 1px solid var(--frame) !important;">
                         <i class="fas fa-apple-alt fa-2x text-warning mb-1"></i>
                         <span class="small fw-bold" style="color: var(--ink);">Meal Logs</span>
                     </a>
                 </div>
                  <div class="col-6 col-md-3">
                     <a asp-controller="Chat" asp-action="Index" class="btn btn-outline-secondary h-100 w-100 p-3 d-flex flex-column align-items-center justify-content-center gap-2 hover-elevate shadow-sm" style="background: var(--tile); border: 1px solid var(--frame) !important;">
                         <i class="fas fa-comments fa-2x text-info mb-1"></i>
                         <span class="small fw-bold" style="color: var(--ink);">Ask Trainer</span>
                     </a>
                 </div>
             </div>

            <!-- Charts Row (Side-by-Side) -->
            <div class="row g-4 mb-4">
                 <!-- Weight Chart -->
                 <div class="col-md-6">
                    <div class="card border-0 shadow-lg h-100" style="background: var(--tile); border: 1px solid var(--frame) !important;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                 <h5 class="mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Weight Progress</h5>
                                 <select class="form-select form-select-sm w-auto" style="background: var(--bg); color: var(--ink); border-color: var(--frame);">
                                     <option>Last 30 Days</option>
                                     <option>Last 6 Months</option>
                                 </select>
                            </div>
                           
                            @if (Model.WeightHistory != null && Model.WeightHistory.Any())
                            {
                                <div style="height: 200px;">
                                    <canvas id="weightChart"></canvas>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 opacity-50">
                                    <i class="fas fa-chart-area fa-3x mb-3"></i>
                                    <p>No weight logs yet.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Consistency Chart -->
                <div class="col-md-6">
                     <div class="card border-0 shadow-lg h-100" style="background: var(--tile); border: 1px solid var(--frame) !important;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                 <h5 class="mb-0"><i class="fas fa-fire me-2 text-warning"></i>Consistency</h5>
                                 <span class="badge bg-warning bg-opacity-10 text-warning">Last 4 Weeks</span>
                            </div>
                           
                            @if (Model.ConsistencyData != null && Model.ConsistencyData.Any())
                            {
                                <div style="height: 200px;">
                                    <canvas id="consistencyChart"></canvas>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 opacity-50">
                                    <i class="fas fa-dumbbell fa-3x mb-3"></i>
                                    <p>Start working out!</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

             <!-- Today's Focus -->
            <h5 class="mb-3 ls-1">Today's Focus</h5>
            <div class="row g-4 mb-4">
                 <!-- Workout Card -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-lg h-100 overflow-hidden">
                        <div class="card-body p-4 position-relative z-1" style="background: color-mix(in srgb, var(--bg) 85%, transparent);">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge bg-primary">Workout</span>
                                <i class="fas fa-running opacity-50"></i>
                            </div>

                            @if (Model.HasWorkoutPlan)
                            {
                                <h4 class="fw-bold mb-2">@Model.TodayWorkoutName</h4>
                                <p class="text-muted mb-4 small">Ready to crush your goals? Start your scheduled training now.</p>
                                <a asp-controller="WorkoutPlanAssignment" asp-action="ViewTodayWorkout" class="btn btn-primary w-100 stretched-link">
                                    Start Workout <i class="fas fa-arrow-right ms-2"></i>
                                </a>
                            }
                            else
                            {
                                <h4 class="fw-bold mb-2">Rest Day</h4>
                                <p class="text-muted mb-4 small">No workout scheduled for today. Rest and recover!</p>
                                <button class="btn btn-outline-secondary w-100 disabled">No Workout Assigned</button>
                            }
                        </div>
                         <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark"
                             style="background-image: url('https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=600&q=80'); background-size: cover; background-position: center; opacity: 0.3; z-index: 0;"></div>
                    </div>
                </div>

                <!-- Nutrition Card -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-lg h-100 overflow-hidden">
                        <div class="card-body p-4 position-relative z-1" style="background: color-mix(in srgb, var(--bg) 85%, transparent);">
                             <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge bg-success">Nutrition</span>
                                <i class="fas fa-carrot opacity-50"></i>
                            </div>

                            @if (Model.HasDietPlan)
                            {
                                <h4 class="fw-bold mb-2">@Model.TodayDietName</h4>
                                <p class="text-muted mb-4 small">Fuel your body efficiently. View your meal plan for today.</p>
                                <a asp-controller="DietPlanAssignment" asp-action="TodayMeal" class="btn btn-success w-100 stretched-link">
                                    View Meals <i class="fas fa-arrow-right ms-2"></i>
                                </a>
                            }
                            else
                            {
                                <h4 class="fw-bold mb-2">Track Calories</h4>
                                <p class="text-muted mb-4 small">No specific diet plan assigned. Remember to eat healthy!</p>
                                <button class="btn btn-outline-secondary w-100 disabled">No Plan Assigned</button>
                            }
                        </div>
                        <div class="position-absolute top-0 start-0 w-100 h-100 bg-dark"
                             style="background-image: url('https://images.unsplash.com/photo-1490818387583-1baba5e638af?auto=format&fit=crop&w=600&q=80'); background-size: cover; background-position: center; opacity: 0.3; z-index: 0;"></div>
                    </div>
                </div>
            </div>
            

        </div>

        <!-- Right Sidebar -->
        <div class="col-lg-4">
             <!-- Quick Access List -->
            <div class="card border-0 mb-4 bg-transparent">
                <h5 class="mb-3 ls-1">Shortcuts</h5>
                <div class="list-group list-group-flush gap-2">
                    <a asp-action="Profile" asp-route-id="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" class="list-group-item list-group-item-action border rounded d-flex align-items-center p-3 hover-elevate shadow-sm" style="background: var(--tile); border-color: var(--frame) !important;">
                        <div class="icon-shape bg-primary bg-opacity-10 text-primary rounded-circle me-3" style="width: 40px; height: 40px; padding: 0.5rem;">
                             <i class="fas fa-user"></i>
                        </div>
                        <span class="fw-bold flex-grow-1">My Profile</span>
                        <i class="fas fa-chevron-right small text-muted"></i>
                    </a>
                    <a asp-action="Payments" class="list-group-item list-group-item-action border rounded d-flex align-items-center p-3 hover-elevate shadow-sm" style="background: var(--tile); border-color: var(--frame) !important;">
                         <div class="icon-shape bg-success bg-opacity-10 text-success rounded-circle me-3" style="width: 40px; height: 40px; padding: 0.5rem;">
                             <i class="fas fa-history"></i>
                        </div>
                        <span class="fw-bold flex-grow-1">Payment History</span>
                        <i class="fas fa-chevron-right small text-muted"></i>
                    </a>
                    <a asp-controller="Notification" asp-action="Index" class="list-group-item list-group-item-action border rounded d-flex align-items-center p-3 hover-elevate shadow-sm" style="background: var(--tile); border-color: var(--frame) !important;">
                         <div class="icon-shape bg-warning bg-opacity-10 text-warning rounded-circle me-3" style="width: 40px; height: 40px; padding: 0.5rem;">
                             <i class="fas fa-bell"></i>
                        </div>
                        <span class="fw-bold flex-grow-1">Notifications</span>
                         <span class="badge bg-danger rounded-pill">0</span>
                    </a>
                </div>
            </div>

            <!-- Rate Trainer -->
             <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border: 1px solid rgba(245, 158, 11, 0.2) !important;">
                <div class="card-body text-center p-4">
                    <div class="mb-3 text-warning">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                    <h5 class="fw-bold mb-2">Enjoying your training?</h5>
                    <p class="text-muted small mb-3">Rate your trainer and help them improve!</p>
                    <button type="button" class="btn btn-warning w-100" onclick="loadReviewModal()">
                        Write a Review
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Weight Modal (Moved outside for cleaner UI) -->
<div class="modal fade" id="weightModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--tile); color: var(--ink); border: 1px solid var(--frame) !important;">
             <div class="modal-header" style="border-bottom: 1px solid var(--frame) !important;">
                <h5 class="modal-title"><i class="fas fa-weight me-2 text-primary"></i>Log Weight</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="LogWeight" method="post">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label small opacity-75">Today's Weight (kg)</label>
                        <div class="input-group">
                            <input type="number" step="0.1" id="WeightInputModal" name="weight" class="form-control" style="background: var(--bg); color: var(--ink); border-color: var(--frame);" required placeholder="e.g. 75.5">
                            <span class="input-group-text" style="background: var(--bg); border-color: var(--frame); color: var(--muted);">kg</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small opacity-75" for="NotesModal">Notes (optional)</label>
                        <textarea id="NotesModal" name="notes" class="form-control" style="background: var(--bg); color: var(--ink); border-color: var(--frame);" rows="2" placeholder="Morning weigh-in..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save Log</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI Floating Chatbot -->
<partial name="_AIChatbot" />

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function loadReviewModal() {
            $.get('/Review/Create', function(data) {
                $('#reviewModalContent').html(data);
                $('#reviewModal').modal('show');
            }).fail(function(xhr, status, error) {
                console.error('Failed to load review modal:', error);
                showToast('error', 'Could not load review form.');
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Weight Chart
            const ctx = document.getElementById('weightChart');
            if (ctx) {
                const history = @Html.Raw(Json.Serialize(Model.WeightHistory));

                if (history && history.length > 0) {
                    const labels = history.map(h => new Date(h.dateRecorded).toLocaleDateString());
                    const data = history.map(h => h.weight);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Weight (kg)',
                                data: data,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#fff',
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--tile').trim(),
                                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--ink').trim(),
                                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--ink').trim(),
                                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--frame').trim(),
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--frame').trim() },
                                    ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() }
                                }
                            }
                        }
                    });
                }
            }

            // Consistency Chart
            const ctxCons = document.getElementById('consistencyChart');
            if (ctxCons) {
                const labels = @Html.Raw(Json.Serialize(Model.ConsistencyLabels));
                const data = @Html.Raw(Json.Serialize(Model.ConsistencyData));
                
                if (data && data.length > 0) {
                    new Chart(ctxCons, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Workouts',
                                data: data,
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderRadius: 4,
                                barThickness: 20
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--frame').trim() },
                                    ticks: { 
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim(),
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() }
                                }
                            }
                        }
                    });
                }
            }

            // Fix focus in Weight Modal
            const weightModal = document.getElementById('weightModal');
            if (weightModal) {
                weightModal.addEventListener('shown.bs.modal', function () {
                    const input = document.getElementById('WeightInputModal');
                    if(input) input.focus();
                });
            }
        });
    </script>
}