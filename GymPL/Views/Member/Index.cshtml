@model GymBLL.ModelVM.PagedResult<GymBLL.ModelVM.Member.MemberVM>

@{
    ViewData["Title"] = "Members";
    var viewType = Context.Request.Query["view"].ToString().ToLower();
    if (string.IsNullOrEmpty(viewType)) viewType = "grid";
    var isGridView = viewType == "grid";
}
<body>
    <div class="container-fluid">
    <!-- Header with toggle buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1" style="color: var(--ink); font-weight: 700;">
                <i class="fas fa-users me-2" style="color: var(--main-color);"></i>Members
                @if (Model.TotalCount > 0)
                {
                    <span style="font-size: 1rem; color: var(--muted); font-weight: 400; margin-left: 0.5rem;">(@Model.TotalCount total)</span>
                }
            </h1>
            <p class="mb-0" style="color: var(--muted);">Manage and follow up with your gym members</p>
        </div>
        <div class="btn-group" role="group">
            <a href="@Url.Action("Index", new { view = "table", page = 1, pageSize = Model.PageSize })"
                class="btn @(viewType == "table" ? "btn-primary" : "btn-outline-primary")">
                <i class="fas fa-table me-1"></i> Table
            </a>
            <a href="@Url.Action("Index", new { view = "grid", page = 1, pageSize = Model.PageSize })"
                class="btn @(viewType == "grid" ? "btn-primary" : "btn-outline-primary")">
                <i class="fas fa-th-large me-1"></i> Grid
            </a>
        </div>
    </div>

    <!-- No Members Message -->
    @if (Model == null || !Model.Items.Any())
    {
        <div class="card" style="background: var(--tile); border: 1px solid var(--frame); border-radius: var(--radius);">
            <div class="card-body text-center py-5">
                <i class="fas fa-user-slash fa-4x mb-3" style="color: var(--muted); opacity: 0.5;"></i>
                <h3 style="color: var(--ink); font-weight: 700;">No Members Found</h3>
                <p style="color: var(--muted);">There are no members registered in the system yet.</p>
            </div>
        </div>
    }
    else
    {
        <!-- TABLE VIEW -->
        @if (!isGridView)
        {
            <div class="card mb-4" style="background: var(--tile); border: 1px solid var(--frame); border-radius: var(--radius);">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Member Directory</h6>
                    <div>
                        <span class="badge bg-secondary text-white">Page @Model.PageNumber of @Model.TotalPages</span>
                        <span class="badge bg-primary text-white ms-2">@Model.TotalCount members</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table text-center align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Join Date</th>
                                    <th>Workout Plan</th>
                                    <th>Diet Plan</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td class="px-4 py-3">
                                            <div class="d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(item.ProfilePicture))
                                                {
                                                    <img src="@item.ProfilePicture" alt="@item.FullName"
                                                            class="member-avatar-sm me-3 shadow-sm">
                                                }
                                                else
                                                {
                                                    <div class="member-avatar-sm me-3 d-flex align-items-center justify-content-center" style="background: var(--frame); color: var(--main-color); font-weight: 700; border-radius: 50%;">
                                                        @item.FullName.Substring(0, 1).ToUpper()
                                                    </div>
                                                }
                                                <span style="font-weight: 600; color: var(--ink);">@item.FullName</span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3" style="color: var(--ink); opacity: 0.85;">@item.Email</td>
                                        <td class="px-4 py-3" style="color: var(--ink); opacity: 0.85;">@item.Phone</td>
                                        <td class="px-4 py-3 text-center" style="color: var(--ink); opacity: 0.85;">@item.JoinDate.ToString("MMM dd, yyyy")</td>
                                        <td class="text-center px-4 py-3">
                                            <div id="workout-status-@item.Id" class="badge bg-opacity-10 rounded-pill px-3" style="background: var(--frame); color: var(--muted);">
                                                <i class="fas fa-spinner fa-spin me-1"></i> Loading...
                                            </div>
                                        </td>
                                        <td class="text-center px-4 py-3">
                                            <div id="diet-status-@item.Id" class="badge bg-opacity-10 rounded-pill px-3" style="background: var(--frame); color: var(--muted);">
                                                <i class="fas fa-spinner fa-spin me-1"></i> Loading...
                                            </div>
                                        </td>
                                        <td class="text-center px-4 py-3">
                                            <div class="d-flex justify-content-center gap-1">
                                               
                                                @if (User.IsInRole("Trainer"))
                                                {
                                                    <a asp-controller="Trainer" asp-action="MemberDetails" asp-route-id="@item.Id"
                                                       class="btn btn-sm btn-primary rounded-pill shadow-sm" style="padding: 0.4rem 0.6rem;" title="Details">
                                                        <i class="fas fa-info-circle"></i>
                                                    </a>
                                                }
                                                else
                                                {
                                                    <a asp-action="Details" asp-route-id="@item.Id"
                                                       class="btn btn-sm btn-primary rounded-pill shadow-sm" style="padding: 0.4rem 0.6rem;" title="Details">
                                                        <i class="fas fa-info-circle"></i>
                                                    </a>
                                                }
                                                    <!-- REPORT BUTTON -->
                                                    <a asp-controller="Report" asp-action="Index"
                                                       asp-route-memberId="@item.Id"
                                                       class="btn btn-sm btn-outline-info rounded-pill shadow-sm"
                                                       style="padding: 0.4rem 0.6rem; border-color: var(--info) !important;"
                                                       title="View Report">
                                                        <i class="fas fa-chart-bar"></i>
                                                    </a>
                                                <a asp-controller="Notification" asp-action="Send" asp-route-userId="@item.Id"
                                                    class="btn btn-sm rounded-pill shadow-sm" style="padding: 0.4rem 0.6rem; background: var(--warning); color: #000;" title="Send Notification">
                                                    <i class="fas fa-bell"></i>
                                                </a>
                                                 <a asp-controller="Chat" asp-action="Index" asp-route-otherUserId="@item.Id"
                                                    class="btn btn-sm btn-outline-success rounded-pill shadow-sm" style="padding: 0.4rem 0.6rem; border-color: var(--success) !important;" title="Chat">
                                                     <i class="fas fa-comments"></i>
                                                 </a>

                                                 <form asp-action="Delete" asp-route-view="@viewType" asp-route-page="@Model.PageNumber" asp-route-id="@item.Id" method="post"
                                                        class="d-inline" onsubmit="return confirm('Are you sure you want to delete @item.FullName?');">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill shadow-sm" style="padding: 0.4rem 0.6rem; border-color: color-mix(in srgb, var(--error) 20%, transparent);" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row g-4">
                @foreach (var member in Model.Items)
                {
                    <div class="col-xl-3 col-lg-4 col-md-6">
                        <div class="card member-card h-100 shadow-sm" style="background: var(--tile); border: 1px solid var(--frame); border-radius: var(--radius); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease;">
                            <div class="card-body p-4">
                                <!-- Profile Section -->
                                <div class="text-center mb-3">
                                    <div class="mx-auto mb-2">
                                        @if (!string.IsNullOrEmpty(member.ProfilePicture))
                                        {
                                            <img src="@member.ProfilePicture" alt="@member.FullName"
                                                    class="member-avatar-md rounded-circle mx-auto">
                                        }
                                            else
                                            {

                                                <img src="~/uploads/profiles/default-profile.png" class="member-avatar-md rounded-circle mx-auto" />
                                            }
                                    </div>
                                    <h5 class="card-title mb-1 fw-bold" style="color: var(--ink);">@member.FullName</h5>
                                    <p class="small mb-0" style="color: var(--muted);">
                                        <i class="fas fa-calendar-alt me-1" style="color: var(--main-color);"></i>
                                        Joined @member.JoinDate.ToString("MMMM yyyy")
                                    </p>
                                </div>

                                <!-- Contact Info -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-envelope me-2" style="color: var(--muted); opacity: 0.7; font-size: 0.85rem;"></i>
                                        <small style="color: var(--ink); opacity: 0.8;">@member.Email</small>
                                    </div>
                                    @if (!string.IsNullOrEmpty(member.Phone))
                                    {
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-phone me-2" style="color: var(--muted); opacity: 0.7; font-size: 0.85rem;"></i>
                                            <small style="color: var(--ink); opacity: 0.8;">@member.Phone</small>
                                        </div>
                                    }
                                </div>

                                <!-- Goal Card -->
                                <div class="mb-4">
                                    <div style="background: var(--frame); border-radius: var(--radius-sm); padding: 0.75rem; text-align: center; border: 1px solid var(--rule);">
                                        <small class="d-block mb-1" style="color: var(--muted); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1px;">Fitness Goal</small>
                                        <span class="fw-bold" style="color: var(--main-color);">
                                            @(member.FitnessGoal?.GoalName ?? "Not Set")
                                        </span>
                                    </div>
                                </div>

                                <!-- Plan Status Section -->
                                <div class="row g-2 mb-4">
                                    <div class="col-6">
                                        <div class="status-box" style="background: var(--bg); border-radius: var(--radius-sm); padding: 0.75rem 0.5rem; text-align: center; border: 1px solid var(--rule);">
                                            <div class="mb-1">
                                                <i class="fas fa-dumbbell" id="grid-workout-icon-@member.Id" style="color: var(--muted); font-size: 0.9rem;"></i>
                                            </div>
                                            <small style="color: var(--muted); display: block; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">Workout</small>
                                            <div id="grid-workout-container-@member.Id" class="mt-2" style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
                                                <span class="badge" id="grid-workout-@member.Id" style="background: var(--frame); color: var(--muted); font-size: 0.65rem; font-weight: 600; border: 1px solid var(--rule);">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="status-box" style="background: var(--bg); border-radius: var(--radius-sm); padding: 0.75rem 0.5rem; text-align: center; border: 1px solid var(--rule);">
                                            <div class="mb-1">
                                                <i class="fas fa-utensils" id="grid-diet-icon-@member.Id" style="color: var(--muted); font-size: 0.9rem;"></i>
                                            </div>
                                            <small style="color: var(--muted); display: block; font-size: 0.7rem; text-transform: uppercase; font-weight: 600;">Diet</small>
                                            <div id="grid-diet-container-@member.Id" class="mt-2" style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
                                                <span class="badge" id="grid-diet-@member.Id" style="background: var(--frame); color: var(--muted); font-size: 0.65rem; font-weight: 600; border: 1px solid var(--rule);">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="member-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
                                   
                                    @if (User.IsInRole("Trainer"))
                                    {
                                        <a asp-controller="Trainer" asp-action="MemberDetails" asp-route-id="@member.Id"
                                           asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)"
                                           class="btn btn-primary rounded-pill shadow-sm" style="padding: 0.6rem; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;">
                                            <i class="fas fa-info-circle"></i> Details
                                        </a>
                                    }
                                    else
                                    {
                                        <a asp-action="Details" asp-route-page="@Model.PageNumber" asp-route-id="@member.Id"
                                           class="btn btn-primary rounded-pill shadow-sm" style="padding: 0.6rem; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;">
                                            <i class="fas fa-info-circle"></i> Details
                                        </a>
                                    }
                                        <a asp-controller="Report" asp-action="Index"
                                                 asp-route-memberId="@member.Id"
                                               asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)"
                                               class="btn btn-outline-info rounded-pill shadow-sm"
                                               style="padding: 0.6rem; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;"
                                               title="View Report">
                                            <i class="fas fa-chart-bar"></i> Report
                                        </a>
                                     <a asp-controller="Chat" asp-action="Index" asp-route-otherUserId="@member.Id" 
                                        class="btn btn-success rounded-pill shadow-sm" style="padding: 0.6rem; font-size: 0.8rem; border: none; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;">
                                         <i class="fas fa-comments"></i> Chat
                                     </a>
                                     <a asp-controller="Notification" asp-action="Send" asp-route-userId="@member.Id" 
                                       asp-route-returnUrl="@(Context.Request.Path + Context.Request.QueryString)"
                                       class="btn btn-warning rounded-pill shadow-sm" style="padding: 0.6rem; font-size: 0.8rem; color: #000; border: none; display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;">
                                        <i class="fas fa-bell"></i> Notify
                                    </a>
                                    <form asp-action="Delete" asp-route-view="@viewType" asp-route-page="@Model.PageNumber" asp-route-id="@member.Id" method="post"
                                          class="w-100" onsubmit="return confirm('Are you sure you want to delete @member.FullName?');">
                                        <button class="btn btn-outline-danger w-100 rounded-pill shadow-sm" type="submit" style="padding: 0.6rem; font-size: 0.8rem; border-color: color-mix(in srgb, var(--error) 30%, transparent); display: flex; align-items: center; justify-content: center; gap: 0.4rem; font-weight: 600;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }

        <!-- PAGINATION -->
        @if (Model.TotalPages > 1)
        {
            <div class="row mt-4">
                <div class="col-12">
                    <!-- Page Info -->
                    <div class="text-center mb-2">
                        <small class="text-muted">
                            Showing @((Model.PageNumber - 1) * Model.PageSize + 1) -
                            @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)
                            of @Model.TotalCount members
                        </small>
                    </div>

                    <!-- Pagination Controls -->
                    <style>
                        .pagination .page-link { background: var(--tile); border-color: var(--frame); color: var(--ink); transition: all 0.2s; }
                        .pagination .page-link:hover { background: var(--frame); color: var(--main-color); border-color: var(--main-color); }
                        .pagination .page-item.active .page-link { background: var(--main-color); border-color: var(--main-color); color: var(--accent-ink); }
                        .pagination .page-item.disabled .page-link { background: rgba(255,255,255,0.05); color: var(--muted); border-color: var(--frame); }
                    </style>
                    <nav aria-label="Members pagination">
                        <ul class="pagination justify-content-center">
                            <!-- Previous Page -->
                            <li class="page-item @(Model.HasPreviousPage ? "" : "disabled")">
                                <a class="page-link" asp-action="Index"
                                    asp-route-view="@viewType"
                                    asp-route-page="@(Model.PageNumber - 1)"
                                    asp-route-pageSize="@Model.PageSize">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>

                            <!-- Page Numbers -->
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" asp-action="Index"
                                        asp-route-view="@viewType"
                                        asp-route-page="@i"
                                        asp-route-pageSize="@Model.PageSize">@i</a>
                                </li>
                            }

                            <!-- Next Page -->
                            <li class="page-item @(Model.HasNextPage ? "" : "disabled")">
                                <a class="page-link" asp-action="Index"
                                    asp-route-view="@viewType"
                                    asp-route-page="@(Model.PageNumber + 1)"
                                    asp-route-pageSize="@Model.PageSize">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script id="memberIdsData" type="application/json">
        {
            "memberIds": @Html.Raw(Json.Serialize(Model.Items.Select(m => m.Id))),
            "viewType": "@viewType"
        }
    </script>
    <script src="~/js/member-index.js" asp-append-version="true"></script>
}
</body>
