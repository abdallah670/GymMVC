@using GymBLL.ModelVM.External
@model GymBLL.ModelVM.User.Member.MemberProfileVM
@{
    ViewData["Title"] = "Complete Your Profile";
    var fitnessGoals = ViewBag.FitnessGoals as List<FitnessGoalsVM> ?? new List<FitnessGoalsVM>();
}

<section class="profile-setup" style="max-width: 800px; margin: 0 auto; padding: 2rem 1rem;">
    <div class="setup-header text-center mb-5">
        <h1 class="display-4" style="color: var(--main-color);">Welcome to MenoPro! 🎉</h1>
        <p class="lead" style="color: var(--muted);">Complete your profile to get personalized workout plans and recommendations</p>
    </div>

    <form method="post" enctype="multipart/form-data" class="setup-form">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        // <input asp-for="Email" hidden />
        // <input asp-for="FullName" hidden />


        <div class="form-grid" style="display: grid; gap: 2rem;">
            <!-- Personal Information -->
            <div class="form-section">
                <h3 style="color: var(--ink); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--main-color);">
                    <i class="fas fa-user"></i> Personal Information
                </h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label asp-for="Height" class="form-label">Height (cm)</label>
                        <input asp-for="Height" type="number" class="form-control" value="176"
                               min="100" max="250" step="1"
                               placeholder="Enter height in cm" required>
                        <span asp-validation-for="Height" class="text-danger"></span>
                    </div>

                    <div>
                        <label asp-for="CurrentWeight" class="form-label">Weight (kg)</label>
                        <input asp-for="CurrentWeight" type="number" class="form-control" value="85"
                               min="30" max="300" step="0.1"
                               placeholder="Enter weight in kg" required>
                        <span asp-validation-for="CurrentWeight" class="text-danger"></span>
                    </div>
                </div>


                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div>
                        <label asp-for="Age" class="form-label">Age</label>
                        <input asp-for="Age" type="number" class="form-control" value="21" required>
                        <span asp-validation-for="Age" class="text-danger"></span>
                    </div>

                    <div>
                        <label asp-for="Gender" class="form-label">Gender</label>
                        <select asp-for="Gender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option value="false">Male</option>
                            <option value="true">Female</option>
                        </select>
                        <span asp-validation-for="Gender" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Fitness Goals -->
            <div class="form-section">
                <h3 style="color: var(--ink); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--main-color);">
                    <i class="fas fa-bullseye"></i> Fitness Goals
                </h3>

                <div>
                    <label asp-for="FitnessGoal" class="form-label">What's your primary fitness goal?</label>
                    <select asp-for="FitnessGoal" class="form-control" required>
                        <option value="">Select your goal</option>
                        @foreach (var goal in fitnessGoals)
                        {
                            <option value="@goal.Id">@goal.GoalName</option>
                        }
                    </select>
                    <span asp-validation-for="FitnessGoal" class="text-danger"></span>
                </div>
            </div>


            <input asp-for="ProfilePicture" hidden />
            <!-- Profile Picture Section -->
            <div class="form-section">
                <h3 style="color: var(--ink); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--main-color);">
                    <i class="fas fa-camera"></i> Profile Picture
                </h3>

                <div style="text-align: center;">
                    <!-- Current Profile Picture Preview -->
                    @if (!string.IsNullOrEmpty(Model.ProfilePicture))
                    {
                        <div class="current-photo">
                            <p class="form-label" style="margin-bottom: 1rem;">Current Photo:</p>
                            <div style="display: inline-block; border-radius: 50%; border: 20px solid var(--main-color); padding: 5px; background: var(--tile);">
                                <img src="@Model.ProfilePicture"
                                     alt="Current Profile"
                                     style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; display: block;"
                                     onerror="this.src='/images/default-profile.png'">
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Default/New Preview -->
                        <div id="imagePreview" style="display: none; text-align: center;">
                            <p class="form-label" style="margin-bottom: 1rem;">Preview:</p>
                            <div style="display: inline-block; border-radius: 50%; border: 20px solid var(--main-color); padding: 5px; background: var(--tile);">
                                <img id="previewImage" src="#"
                                     alt="Image Preview"
                                     style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; display: block;">
                            </div>
                        </div>

                        <!-- Default Placeholder -->
                        <div id="defaultPreview" style="text-align: center;">
                            <p class="form-label" style="margin-bottom: 1rem;">No Profile Picture</p>
                            <div style="display: inline-block; border-radius: 50%; border: 20px solid var(--frame); padding: 5px; background: var(--tile);">
                                <div style="width: 200px; height: 200px; border-radius: 50%; background: color-mix(in srgb, var(--frame) 30%, transparent); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="font-size: 5rem; color: var(--muted);"></i>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- File Upload -->
                    <div class="file-upload-container" style="margin-top: 2rem;">
                        <label asp-for="ProfileImageFile" class="form-label">Upload New Profile Picture</label>

                        <div class="file-input-wrapper" style="display: inline-block;">
                            <!-- Custom styled file input -->
                            <label for="ProfileImageFile" class="custom-file-upload"
                                   style="background: linear-gradient(135deg, var(--main-color), var(--secondary-color));
                          color: var(--accent-ink);
                          padding: 1rem 2rem;
                          border-radius: var(--radius);
                          cursor: pointer;
                          display: inline-flex;
                          align-items: center;
                          gap: 0.5rem;
                          font-weight: 600;
                          transition: all 0.3s ease;">
                                <i class="fas fa-cloud-upload-alt"></i> Choose File
                            </label>
                            <input asp-for="ProfileImageFile" type="file" id="ProfileImageFile"
                                   class="form-control file-input"
                                   style="display: none;"
                                   accept=".jpg,.jpeg,.png,.gif">

                            <div class="file-info" style="margin-top: 1rem; text-align: center;">
                                <span id="fileName" style="color: var(--muted); font-size: 0.9rem;">No file chosen</span>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 1rem;">
                            <small class="form-text text-muted">Optional. JPG, PNG or GIF, max 5MB.</small>
                            <span asp-validation-for="ProfileImageFile" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center" style="margin-top: 3rem;">
            <button type="submit" class="btn btn-primary btn-lg" style="padding: 1rem 3rem;">
                <i class="fas fa-rocket"></i> Complete Setup & Start Training
            </button>
        </div>
    </form>
</section>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.querySelector('input[type="file"]');
            const fileNameSpan = document.getElementById('fileName');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const form = document.getElementById('profileForm');

            // File input change handler
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        // Update file name display
                        fileNameSpan.textContent = this.files[0].name;

                        // Validate file size (5MB max)
                        if (this.files[0].size > 5 * 1024 * 1024) {
                            alert('File size cannot exceed 5MB');
                            this.value = '';
                            fileNameSpan.textContent = 'No file chosen';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        // Validate file type
                        const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif'];
                        const fileExtension = this.files[0].name.toLowerCase().substring(this.files[0].name.lastIndexOf('.'));
                        if (!allowedExtensions.includes(fileExtension)) {
                            alert('Only JPG, JPEG, PNG, and GIF files are allowed');
                            this.value = '';
                            fileNameSpan.textContent = 'No file chosen';
                            imagePreview.style.display = 'none';
                            return;
                        }

                        // Show image preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            imagePreview.style.display = 'block';
                        }
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        fileNameSpan.textContent = 'No file chosen';
                        imagePreview.style.display = 'none';
                    }
                });
            }

            // Form validation
            if (form) {
                form.addEventListener('submit', function(e) {
                    // You can add additional validation here if needed

                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                    submitBtn.disabled = true;

                    // Allow form to submit normally
                    return true;
                });
            }

            // Clear default values for number inputs
            const numberInputs = document.querySelectorAll('input[type="number"]');
            numberInputs.forEach(input => {
                if (input.value === '0') {
                    input.value = '';
                }
            });
        });
    </script>
}