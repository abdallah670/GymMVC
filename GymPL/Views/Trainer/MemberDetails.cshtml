@model GymBLL.ModelVM.Member.MemberDietWorkoutPlansVM
@{
    ViewData["Title"] = "Member Details";
    bool hasWorkout = ViewBag.HasWorkout != null && (bool)ViewBag.HasWorkout;
    bool hasDiet = ViewBag.HasDiet != null && (bool)ViewBag.HasDiet;
    var currentUrl = Context.Request.Path + Context.Request.QueryString; // Add this line to define currentUrl
    var returnUrl = ViewBag.ReturnUrl;// Get returnUrl from query string

}

<div class="member-details-container">
    <!-- Back Button -->
    <div class="assignment-header mb-4">
        <a href="@returnUrl" class="btn btn-outline-primary shadow-sm rounded-pill px-4">
            <i class="fas fa-arrow-left me-2"></i>Back to Members
        </a>
    </div>

    <!-- Member Profile Header -->
    <div class="member-profile-header mb-4" style="background: var(--tile); border: 1px solid var(--frame); border-radius: var(--radius); padding: 2rem; box-shadow: var(--shadow-rest);">
        <div class="member-header-content d-flex align-items-center">
            <div class="member-header-avatar me-4 shadow-sm" style="width: 80px; height: 80px; background: var(--primary-gradient, linear-gradient(135deg, #4e73df 0%, #224abe 100%)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: white;">
                @Model.FullName?.Substring(0, 1).ToUpper()
            </div>
            <div class="member-header-info">
                <h2 class="fw-bold mb-2" style="color: var(--ink);">@Model.FullName</h2>
                <div class="d-flex flex-column gap-1">
                    <div class="info-line d-flex align-items-center" style="color: var(--muted); font-size: 0.95rem;">
                        <i class="fas fa-envelope me-2"></i> @Model.Email
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Phone))
                    {
                        <div class="info-line d-flex align-items-center" style="color: var(--muted); font-size: 0.95rem;">
                            <i class="fas fa-phone me-2"></i> @Model.Phone
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (ViewBag.HasActiveSubscription == false)
    {
        <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center rounded-3" role="alert" style="background: rgba(255, 193, 7, 0.1); color: #856404; border-left: 5px solid #ffc107 !important;">
            <i class="fas fa-exclamation-triangle me-3 fa-lg"></i>
            <div>
                <strong>No Active Subscription:</strong> This member does not have an active subscription. You cannot assign workout or diet plans until a subscription is created.
            </div>
        </div>
    }

    <div class="trainer-view-grid">
        <!-- Left Column -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">

            <!-- Member Information -->
            <div class="trainer-card">
                <h3 class="trainer-card-title">
                    <i class="fas fa-info-circle text-primary"></i> Member Information
                </h3>
                <div class="trainer-card-grid">
                    <div>
                        <div class="info-item-label">Join Date</div>
                        <div class="info-item-value">@Model.JoinDate.ToString("MMMM dd, yyyy")</div>
                    </div>
                    @if (Model.FitnessGoal != null && !string.IsNullOrEmpty(Model.FitnessGoal.GoalName))
                    {
                        <div>
                            <div class="info-item-label">Fitness Goal</div>
                            <div class="info-item-value">@Model.FitnessGoal.GoalName</div>
                        </div>
                    }
                    <div>
                        <div class="info-item-label">Current Weight</div>
                        <div class="info-item-value">@Model.CurrentWeight kg</div>
                    </div>
                    <div>
                        <div class="info-item-label">Height</div>
                        <div class="info-item-value">@Model.Height cm</div>
                    </div>
                </div>

                @if (Model.FitnessGoal != null && !string.IsNullOrEmpty(Model.FitnessGoal.GoalDescription))
                {
                    <div class="mt-4 pt-3" style="border-top: 1px solid var(--frame);">
                        <div class="info-item-label">Goal Description</div>
                        <div style="color: var(--ink); opacity: 0.85; font-size: 0.95rem; line-height: 1.6;">@Model.FitnessGoal.GoalDescription</div>
                    </div>
                }
            </div>

            <!-- Assigned Workout Plans -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0 fw-bold" style="color: var(--ink); font-size: 1.25rem;">
                        <i class="fas fa-dumbbell text-primary me-2"></i>Workout Plans
                    </h3>
                    @if (!hasWorkout || Model.WorkoutAssignmentVM == null)
                    {
                        <div style="display: flex; gap: 0.5rem;">
                            @if (ViewBag.HasActiveSubscription == true)
                            {
                                <button type="button" class="btn btn-outline-info btn-sm rounded-pill px-3" onclick="getAISuggestion('Workout')">
                                    <i class="fas fa-robot me-1"></i> AI Suggest
                                </button>
                                <a asp-controller="WorkoutPlanAssignment" asp-action="Assign" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                                   class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
                                    <i class="fas fa-plus me-1"></i> Assign
                                </a>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" disabled title="Requires active subscription">
                                    <i class="fas fa-robot me-1"></i> AI Suggest
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm rounded-pill px-3" disabled title="Requires active subscription">
                                    <i class="fas fa-plus me-1"></i> Assign
                                </button>
                            }
                        </div>
                    }
                    else
                    {
						<div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-outline-info btn-sm rounded-pill px-3" onclick="getAISuggestion('Workout')">
                                <i class="fas fa-robot me-1"></i> AI Suggest
                            </button>

                            <a asp-controller="WorkoutPlanAssignment" asp-action="Edit" asp-route-id="@Model.WorkoutAssignmentVM.Id" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                               class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                <i class="fas fa-exchange-alt me-1"></i> Reassign
                            </a>
                        </div>
                    }
                </div>

                @if (!hasWorkout || Model.WorkoutAssignmentVM == null)
                {
                    <div class="text-center py-5" style="color: var(--muted);">
                        <i class="fas fa-dumbbell fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0 font-weight-bold">No workout plan assigned</p>
                    </div>
                }
                else
                {
                    <div class="trainer-plan-item">
                        <div class="trainer-plan-header">
                            <div>
                                <div class="trainer-plan-name">
                                    @Model.WorkoutAssignmentVM?.WorkoutPlan?.Name
                                </div>
                                <div class="trainer-plan-dates">
                                    <i class="fas fa-calendar-alt"></i>
                                    @Model.WorkoutAssignmentVM?.StartDate.ToString("MMM dd, yyyy") -
                                    @Model.WorkoutAssignmentVM?.EndDate.ToString("MMM dd, yyyy")
                                </div>
                            </div>
                            @if (Model.WorkoutAssignmentVM?.WorkoutPlan?.DurationWeeks != null)
                            {
                                <span class="badge badge-success">
                                    @Model.WorkoutAssignmentVM.WorkoutPlan.DurationWeeks weeks
                                </span>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(Model.WorkoutAssignmentVM?.Notes))
                        {
                            <div class="trainer-notes-box">
                                <div class="trainer-notes-label">
                                    <i class="fas fa-sticky-note me-1"></i>Trainer Notes:
                                </div>
                                <div style="color: var(--ink); opacity: 0.9; font-size: 0.9rem; line-height: 1.5;">
                                    @Model.WorkoutAssignmentVM.Notes
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Assigned Diet Plans -->
            <div class="trainer-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0 fw-bold" style="color: var(--ink); font-size: 1.25rem;">
                        <i class="fas fa-utensils text-success me-2"></i>Diet Plans
                    </h3>
                    @if (!hasDiet || Model.DietPlanAssignmentVM == null)
                    {
                        <div style="display: flex; gap: 0.5rem;">
                            @if (ViewBag.HasActiveSubscription == true)
                            {
                                <button type="button" class="btn btn-outline-info btn-sm rounded-pill px-3" onclick="getAISuggestion('Diet')">
                                    <i class="fas fa-robot me-1"></i> AI Suggest
                                </button>
                                <a asp-controller="DietPlanAssignment" asp-action="Assign" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                                   class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
                                    <i class="fas fa-plus me-1"></i> Assign
                                </a>
                            }
                            else
                            {
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" disabled title="Requires active subscription">
                                    <i class="fas fa-robot me-1"></i> AI Suggest
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm rounded-pill px-3" disabled title="Requires active subscription">
                                    <i class="fas fa-plus me-1"></i> Assign
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-outline-info btn-sm rounded-pill px-3" onclick="getAISuggestion('Diet')">
                                <i class="fas fa-robot me-1"></i> AI Suggest
                            </button>
                           
                            <a asp-controller="DietPlanAssignment" asp-action="Edit" asp-route-id="@Model.DietPlanAssignmentVM.Id" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                               class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                <i class="fas fa-exchange-alt me-1"></i> Reassign
                            </a>
                        </div>
                     }
                </div>

                @if (!hasDiet || Model.DietPlanAssignmentVM == null)
                {
                    <div class="text-center py-5" style="color: var(--muted);">
                        <i class="fas fa-utensils fa-3x mb-3 opacity-25"></i>
                        <p class="mb-0 font-weight-bold">No diet plan assigned</p>
                    </div>
                }
                else
                {
                    <div class="trainer-plan-item">
                        <div class="trainer-plan-header">
                            <div>
                                <div class="trainer-plan-name">
                                    @Model.DietPlanAssignmentVM?.DietPlan?.Name
                                </div>
                                <div class="trainer-plan-dates">
                                    <i class="fas fa-calendar-alt"></i>
                                    @Model.DietPlanAssignmentVM?.StartDate.ToString("MMM dd, yyyy") -
                                    @Model.DietPlanAssignmentVM?.EndDate.ToString("MMM dd, yyyy")
                                </div>
                                @if (Model.DietPlanAssignmentVM?.DietPlan?.TotalCalories > 0)
                                {
                                    <div class="trainer-plan-dates">
                                        <i class="fas fa-fire"></i> @Model.DietPlanAssignmentVM.DietPlan.TotalCalories calories/day
                                    </div>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(Model.DietPlanAssignmentVM?.DietPlan?.DietType))
                            {
                                <span class="badge badge-info">
                                    @Model.DietPlanAssignmentVM.DietPlan.DietType
                                </span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Right Column - Quick Actions & Stats -->
        <div>
            <!-- Quick Actions -->
            <div class="trainer-card" style="margin-bottom: 1.5rem;">
                <h3 class="trainer-card-title">
                    <i class="fas fa-bolt text-warning"></i> Quick Actions
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="@Url.Action("Index", "Report", new { memberId = Model.Id })" 
                       class="btn btn-primary btn-block text-left mb-2">
                        <i class="fas fa-file-alt mr-2"></i> View Progress Report
                    </a>
                    @if (!hasWorkout)
                    {
                        <a asp-controller="WorkoutPlanAssignment" asp-action="Assign" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                           class="btn btn-outline-primary btn-block text-left">
                            <i class="fas fa-dumbbell mr-2"></i> Assign Workout Plan
                        </a>
                    }
                    else
                    {
                        <a asp-controller="WorkoutPlanAssignment" asp-action="Edit" asp-route-id="@Model.WorkoutAssignmentVM?.Id" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                           class="btn btn-outline-primary btn-block text-left">
                            <i class="fas fa-edit mr-2"></i> Reassign Workout Plan
                        </a>
                    }

                    @if (!hasDiet)
                    {
                        <a asp-controller="DietPlanAssignment" asp-action="Assign" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"
                           class="btn btn-outline-primary btn-block text-left">
                            <i class="fas fa-utensils mr-2"></i> Assign Diet Plan
                        </a>
                    }
                    else
                    {
                        <a asp-controller="DietPlanAssignment" asp-action="Edit" asp-route-id="@Model.DietPlanAssignmentVM?.Id" asp-route-memberId="@Model.Id" asp-route-returnUrl="@currentUrl"

                           class="btn btn-outline-primary btn-block text-left">
                            <i class="fas fa-edit mr-2"></i> Reassign Diet Plan
                        </a>
                    }
                </div>
            </div>

            <!-- Member Stats -->
            <div class="trainer-card">
                <h3 class="trainer-card-title">
                    <i class="fas fa-chart-bar text-info"></i> Member Stats
                </h3>
                <div class="d-flex flex-column gap-3 mt-3">
                    <div class="d-flex justify-content-between align-items-center py-2 px-3 rounded-3" style="background: var(--bg); border: 1px solid var(--rule);">
                        <span style="color: var(--muted); font-size: 0.9rem; font-weight: 500;">Workout Plan</span>
                        <span class="badge rounded-pill @(hasWorkout ? "bg-success" : "bg-secondary") bg-opacity-10 @(hasWorkout ? "text-success" : "text-muted") border-0 px-3 py-2" style="font-size: 0.75rem;">
                            @(hasWorkout ? "Active" : "None")
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-2 px-3 rounded-3" style="background: var(--bg); border: 1px solid var(--rule);">
                        <span style="color: var(--muted); font-size: 0.9rem; font-weight: 500;">Diet Plan</span>
                        <span class="badge rounded-pill @(hasDiet ? "bg-success" : "bg-secondary") bg-opacity-10 @(hasDiet ? "text-success" : "text-muted") border-0 px-3 py-2" style="font-size: 0.75rem;">
                            @(hasDiet ? "Active" : "None")
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Suggestion Modal -->
<div class="modal fade" id="aiSuggestionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border-radius: 1.2rem; border: 1px solid var(--frame); overflow: hidden; box-shadow: var(--shadow-rest); background: var(--tile);">
            <div class="modal-header border-0" style="background: var(--primary-gradient, linear-gradient(135deg, #4e73df 0%, #224abe 100%)); color: white;">
                <h5 class="modal-title font-weight-bold" id="aiModalLabel" style="color: white !important;">
                    <i class="fas fa-robot me-2"></i>AI Plan Suggestion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="aiModalBody" style="padding: 2rem; background: var(--bg);">
                <div id="aiLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">MenoPro AI is crafting a tailored plan...</p>
                </div>
                <div id="aiContent" style="display: none;">
                    <div class="suggestion-card shadow-sm border" style="background: var(--tile); border-color: var(--frame) !important;">
                        <h4 id="suggestedPlanName" class="text-primary mb-3 fw-bold"></h4>
                        <p id="suggestedDescription" style="color: var(--ink); opacity: 0.8;"></p>
                        <div id="suggestedStats" class="row mb-4"></div>
                        
                        <div class="suggestion-items-container">
                            <h6 class="mb-3 fw-bold" style="color: var(--ink);">Planned Items:</h6>
                            <ul id="suggestedItems" class="list-group list-group-flush rounded-3 border overflow-hidden"></ul>
                        </div>

                        <div class="mt-4 p-3 rounded shadow-sm border-left-primary" style="background: var(--bg); border: 1px solid var(--frame); border-left: 5px solid #4e73df !important;">
                            <h6 class="text-primary font-weight-bold small text-uppercase mb-2">AI Reasoning:</h6>
                            <p id="suggestedReasoning" class="mb-0 small fst-italic" style="color: var(--ink); opacity: 0.7;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0" style="background: var(--bg); padding: 1.5rem;">
                <button type="button" class="btn btn-link text-muted" data-dismiss="modal">Close</button>
                <button type="button" id="applyAISuggestion" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="fas fa-check me-2"></i>Apply & Assign to Member
                </button>
            </div>
        </div>
    </div>
</div>



<partial name="_AIChatbot" />

<style>
    .suggestion-card {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .border-left-primary {
        border-left: 4px solid #4e73df;
    }
</style>

<script>
    let currentSuggestion = null;
    const memberId = "@Model.Id";

    async function getAISuggestion(type) {
        $('#aiSuggestionModal').modal('show');
        $('#aiLoading').show();
        $('#aiContent').hide();
        $('#applyAISuggestion').hide();

        try {
            const response = await fetch(`/Trainer/GetAISuggestion?memberId=${memberId}&type=${type}`);
            const data = await response.json();
            
            if (data.isError) {
                alert(data.errorMessage);
                $('#aiSuggestionModal').modal('hide');
                return;
            }

            currentSuggestion = data;
            currentSuggestion.type = type; // Keep track of whether it's Diet or Workout

            // Render content
            document.getElementById('suggestedPlanName').innerText = data.planName;
            document.getElementById('suggestedDescription').innerText = data.description;
            document.getElementById('suggestedReasoning').innerText = data.reasoning;

            let statsHtml = '';
            let itemsHtml = '';

            if (type === 'Diet') {
                statsHtml = `
                    <div class="col-6"><div class="small text-muted">Calories</div><strong>${data.totalCalories} kcal</strong></div>
                    <div class="col-6"><div class="small text-muted">Type</div><strong>${data.recommendedDietType}</strong></div>
                `;
                data.suggestedMeals.forEach(meal => {
                    itemsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <div><strong>${meal.mealName}</strong><br><small>${meal.notes || ''}</small></div>
                    </li>`;
                });
            } else {
                statsHtml = `
                    <div class="col-6"><div class="small text-muted">Difficulty</div><strong>${data.difficultyLevel}</strong></div>
                `;
                data.suggestedExercises.forEach(ex => {
                    itemsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <div><strong>${ex.exerciseName}</strong><br><small>${ex.notes || ''}</small></div>
                        <span class="badge badge-primary badge-pill">${ex.sets}x${ex.reps}</span>
                    </li>`;
                });
            }

            document.getElementById('suggestedStats').innerHTML = statsHtml;
            document.getElementById('suggestedItems').innerHTML = itemsHtml;

            $('#aiLoading').hide();
            $('#aiContent').fadeIn();
            $('#applyAISuggestion').show();

        } catch (error) {
            console.error('Error fetching AI suggestion:', error);
            alert('Failed to get AI suggestion. Please try again.');
            $('#aiSuggestionModal').modal('hide');
        }
    }

    document.getElementById('applyAISuggestion').onclick = async () => {
        const btn = document.getElementById('applyAISuggestion');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Applying...';

        try {
            const response = await fetch(`/Trainer/ApplyAISuggestion?memberId=${memberId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentSuggestion)
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.text();
                alert('Apply failed: ' + error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Apply & Assign to Member';
            }
        } catch (error) {
            console.error('Apply Error:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check mr-2"></i> Apply & Assign to Member';
        }
    };

  
 
</script>
