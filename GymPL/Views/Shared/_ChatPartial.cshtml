@using GymPL.Extensions
@using System.Security.Claims
<li class="nav-item dropdown mx-2" id="chatDropdownContainer">
    <a class="nav-link position-relative p-2" href="#" id="chatDropdown" role="button"
       data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="color: var(--ink);">
        <i class="fas fa-comment-dots fa-lg"></i>
        <!-- Counter - Messages -->
        <span class="badge bg-primary badge-counter" id="chatBadge"
              style="position: absolute; top: 2px; right: 2px; font-size: 0.6rem; display: none;">
            0
        </span>
    </a>
    <!-- Dropdown - Chat -->
    <div class="dropdown-menu dropdown-menu-end shadow p-0"
         aria-labelledby="chatDropdown" style="min-width: 320px;">
        <h6 class="dropdown-header py-3 bg-primary text-white">
            <i class="fas fa-comments me-2"></i>Messages
        </h6>
        <div id="chatMessageList" class="p-0" style="max-height: 400px; overflow-y: auto;">
            <!-- Chat previews injected here -->
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                <p class="text-muted mb-0">Checking messages...</p>
            </div>
        </div>
        <div class="p-2 border-top bg-light">
            <a class="btn btn-sm btn-primary w-100" href="/Chat/Index">
                <i class="fas fa-paper-plane me-2"></i>Open Chat
            </a>
        </div>
    </div>
</li>

<script>
    const chatNotificationConnection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .withAutomaticReconnect()
        .build();

    chatNotificationConnection.on("ReceiveMessage", function (senderId, message, timestamp, attachmentUrl, attachmentType, senderName, senderPicture) {
        if (senderId !== '@User.GetUserId()') {
            // New message from someone else - reload unread
            loadUnreadMessages();
            
            // Optional: Show a toast/alert or sound
            if (typeof Swal !== 'undefined' && !window.location.pathname.includes('/Chat')) {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
                Toast.fire({
                    icon: 'info',
                    title: `New message from ${senderName}`,
                    text: attachmentType ? `[${attachmentType}]` : message.substring(0, 30) + '...'
                });
            }
        }
    });

    chatNotificationConnection.on("MessageRead", function (messageId) {
        // Refresh unread count when a message is read
        loadUnreadMessages();
    });

    chatNotificationConnection.start().catch(err => console.error(err.toString()));

    document.addEventListener("DOMContentLoaded", function() {
        loadUnreadMessages();
    });

    async function loadUnreadMessages() {
        try {
            const response = await fetch('@Url.Action("GetUnreadMessages", "Chat")');
            if (!response.ok) throw new Error('Fetch failed');
            const data = await response.json();

            if (data.success && data.messages) {
                updateChatUI(data.messages);
            } else {
                updateChatUI([]); // Clear spinner
            }
        } catch (error) {
            console.error('Error fetching chat messages:', error);
            updateChatUI([]); // Clear spinner even on error
        }
    }

    function updateChatUI(messages) {
        const badge = document.getElementById('chatBadge');
        const list = document.getElementById('chatMessageList');

        if (messages.length > 0) {
            badge.textContent = messages.length > 9 ? '9+' : messages.length;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }

        if (messages.length === 0) {
            list.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-check-circle mb-2 d-block"></i>
                    <p class="mb-0">No unread messages</p>
                </div>`;
            return;
        }

        let html = '';
        // Group by sender to show one preview per person
        const grouped = {};
        messages.forEach(m => {
            if (!grouped[m.senderId]) {
                grouped[m.senderId] = m;
            }
        });

        Object.values(grouped).forEach(m => {
            const time = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messagePreview = m.attachmentType ? `<i class="fas fa-paperclip"></i> ${m.attachmentType}` : m.message;
            
            html += `
                <a class="dropdown-item d-flex align-items-center py-3 border-bottom border-light" href="/Chat/Index?otherUserId=${m.senderId}">
                    <div class="dropdown-list-image me-3">
                        ${m.senderPicture 
                            ? `<img class="rounded-circle" src="${m.senderPicture}" style="width: 40px; height: 40px; object-fit: cover;">`
                            : `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">${m.senderName ? m.senderName[0] : 'U'}</div>`
                        }
                    </div>
                    <div class="w-100 overflow-hidden">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-dark font-size-sm">${m.senderName}</span>
                            <span class="text-muted small">${time}</span>
                        </div>
                        <div class="text-muted text-truncate small">${messagePreview}</div>
                    </div>
                </a>`;
        });

        list.innerHTML = html;
    }
</script>
